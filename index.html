<!-- Ù…Ø­Ø§Ø¯Ø«Ø© ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø®Ø§Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚! -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ© - Ø¨Ø¯ÙˆÙ† Ø®Ø§Ø¯Ù…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .dark .gradient-bg { background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%); }
        .message-animation { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .image-hover { transition: all 0.3s ease; }
        .image-hover:hover { transform: scale(1.05); }
        input[type="password"], input[type="text"], textarea { font-size: 16px; }
        .online-indicator { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    
    <!-- Ø´Ø§Ø´Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØºØ±ÙØ© -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full p-8">
            <!-- ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù†ÙˆØ¹ -->
            <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-xl border border-blue-200 dark:border-blue-800">
                <div class="flex items-start space-x-3 space-x-reverse">
                    <div class="text-2xl">ğŸ’¡</div>
                    <div>
                        <h3 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ©</h3>
                        <p class="text-sm text-blue-700 dark:text-blue-300">
                            ØªØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø®Ø§Ø¯Ù…! Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ - ØªÙ†ØªÙ‡ÙŠ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
                        </p>
                    </div>
                </div>
            </div>

            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-4">ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©</h1>
                <p class="text-gray-600 dark:text-gray-300 text-lg">Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙˆØ±ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø®ÙˆØ§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠØ©</p>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± -->
                <div class="space-y-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                    Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
                                </label>
                                <input type="text" id="usernameInput" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg 
                                              focus:outline-none focus:border-primary dark:bg-gray-600 dark:text-white text-base"
                                       placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" required>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                    ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©:
                                </label>
                                <input type="text" id="roomCodeInput" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg 
                                              focus:outline-none focus:border-primary dark:bg-gray-600 dark:text-white text-base"
                                       placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ù„: test123)" required>
                                <p class="text-xs text-gray-500 mt-1">Ø´Ø§Ø±Ùƒ Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù† -->
                <div class="space-y-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                        <button id="enterRoomBtn" 
                                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 
                                       text-white font-bold py-4 px-6 rounded-xl text-lg
                                       transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <span id="enterBtnText">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                        </button>
                        
                        <div class="mt-4 space-y-3">
                            <button id="generateRoomBtn" 
                                    class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                ğŸ² Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                            </button>
                            
                            <button id="shareRoomCodeBtn" 
                                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg transition-colors"
                                    disabled>
                                ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙƒÙˆØ¯
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                        <h3 class="font-semibold mb-3 text-gray-800 dark:text-white">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="text-center p-3 bg-blue-100 dark:bg-blue-900 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="activeRooms">0</div>
                                <div class="text-blue-800 dark:text-blue-300">ØºØ±Ù Ù†Ø´Ø·Ø©</div>
                            </div>
                            <div class="text-center p-3 bg-green-100 dark:bg-green-900 rounded-lg">
                                <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="totalUsers">0</div>
                                <div class="text-green-800 dark:text-green-300">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ØºØ±ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
    <div id="chatScreen" class="hidden min-h-screen flex flex-col">
        <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
        <div class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-6xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white text-xl font-bold">
                            ğŸ’¬
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ©
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2 online-indicator"></div>
                            </h1>
                            <div class="flex items-center space-x-4 space-x-reverse text-sm text-gray-600 dark:text-gray-300">
                                <span id="roomInfo">Ø§Ù„ØºØ±ÙØ©: --</span>
                                <span id="userCount">â€¢ 1 Ù…Ø³ØªØ®Ø¯Ù…</span>
                                <span id="messageCount">â€¢ 0 Ø±Ø³Ø§Ù„Ø©</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <button id="shareCurrentRoomBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©
                        </button>
                        <button id="leaveRoomBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                            ğŸšª Ù…ØºØ§Ø¯Ø±Ø©
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
        <div class="flex-1 flex flex-col max-w-6xl mx-auto w-full">
            <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">ğŸ‰</div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†...</p>
                </div>
            </div>

            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© -->
            <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
                <div class="flex items-end space-x-4 space-x-reverse">
                    <div class="flex-1 relative">
                        <textarea id="messageInput" 
                                  class="w-full p-4 pr-12 border border-gray-300 dark:border-gray-600 rounded-xl 
                                         resize-none focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20
                                         dark:bg-gray-700 dark:text-white text-base max-h-32"
                                  placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." 
                                  rows="2"></textarea>
                        <div id="charCount" class="absolute bottom-2 left-2 text-xs text-gray-400">0/500</div>
                    </div>
                    
                    <button id="sendMessageBtn" 
                            class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl transition-colors"
                            title="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©">
                        ğŸš€
                    </button>
                </div>
                
                <div class="mt-3 text-center">
                    <span class="text-xs text-gray-500">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ - ØªÙ†ØªÙ‡ÙŠ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        let currentRoom = null;
        let currentUser = null;
        let messages = [];
        let users = new Set();
        let broadcastChannel = null;

        // Ø¹Ù†Ø§ØµØ± DOM
        let loginScreen, chatScreen, usernameInput, roomCodeInput;
        let enterRoomBtn, enterBtnText, generateRoomBtn, shareRoomCodeBtn;
        let messagesContainer, messageInput, sendMessageBtn, charCount;
        let roomInfo, userCount, messageCount, activeRooms, totalUsers;
        let shareCurrentRoomBtn, leaveRoomBtn;

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        function generateRandomCode() {
            const adjectives = ['Ø£Ø­Ù…Ø±', 'Ø£Ø²Ø±Ù‚', 'Ø£Ø®Ø¶Ø±', 'Ø£ØµÙØ±', 'Ø¨Ù†ÙØ³Ø¬ÙŠ', 'ÙˆØ±Ø¯ÙŠ', 'Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ', 'Ø¨Ù†ÙŠ'];
            const nouns = ['Ù‚Ø·Ø©', 'ÙƒÙ„Ø¨', 'Ø£Ø³Ø¯', 'Ù†Ù…Ø±', 'ÙÙŠÙ„', 'Ø²Ø±Ø§ÙØ©', 'Ø­ØµØ§Ù†', 'Ø·Ø§Ø¦Ø±'];
            const numbers = Math.floor(Math.random() * 1000);
            
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            
            return `${adj}_${noun}_${numbers}`;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStats() {
            const allRooms = JSON.parse(localStorage.getItem('localChatRooms') || '{}');
            const roomCount = Object.keys(allRooms).length;
            let userCount = 0;
            
            Object.values(allRooms).forEach(room => {
                userCount += room.users ? room.users.length : 0;
            });
            
            if (activeRooms) activeRooms.textContent = roomCount;
            if (totalUsers) totalUsers.textContent = userCount;
        }

        // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„
        function updateEnterButton() {
            const hasUsername = usernameInput && usernameInput.value.trim().length > 0;
            const hasRoomCode = roomCodeInput && roomCodeInput.value.trim().length > 0;
            
            if (enterRoomBtn) {
                enterRoomBtn.disabled = !(hasUsername && hasRoomCode);
                
                if (hasUsername && hasRoomCode) {
                    enterRoomBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    enterBtnText.textContent = 'ğŸ’¬ Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©';
                } else {
                    enterRoomBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    if (!hasUsername) {
                        enterBtnText.textContent = 'ğŸ‘¤ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
                    } else if (!hasRoomCode) {
                        enterBtnText.textContent = 'ğŸ”‘ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©';
                    }
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
            if (shareRoomCodeBtn) {
                shareRoomCodeBtn.disabled = !hasRoomCode;
                shareRoomCodeBtn.classList.toggle('opacity-50', !hasRoomCode);
            }
        }

        // Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©
        function enterRoom() {
            if (!usernameInput.value.trim() || !roomCodeInput.value.trim()) {
                showAlert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }

            currentRoom = roomCodeInput.value.trim();
            currentUser = {
                id: Date.now().toString(),
                username: usernameInput.value.trim(),
                joinTime: Date.now()
            };

            // Ø¥Ø¹Ø¯Ø§Ø¯ BroadcastChannel Ù„Ù„ØªÙˆØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ§Ø¨Ø§Øª
            if (broadcastChannel) {
                broadcastChannel.close();
            }
            broadcastChannel = new BroadcastChannel(`chat_${currentRoom}`);
            
            broadcastChannel.addEventListener('message', (event) => {
                const { type, data } = event.data;
                
                if (type === 'newMessage') {
                    displayMessage(data);
                    updateMessageCount();
                } else if (type === 'userJoined') {
                    users.add(data.username);
                    updateUserCount();
                    displayMessage({
                        text: `${data.username} Ø§Ù†Ø¶Ù… Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ğŸ‘‹`,
                        type: 'system',
                        timestamp: Date.now()
                    });
                } else if (type === 'userLeft') {
                    users.delete(data.username);
                    updateUserCount();
                    displayMessage({
                        text: `${data.username} ØºØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ğŸ‘‹`,
                        type: 'system',
                        timestamp: Date.now()
                    });
                }
            });

            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            loginScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØºØ±ÙØ©
            if (roomInfo) roomInfo.textContent = `Ø§Ù„ØºØ±ÙØ©: ${currentRoom}`;
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            loadRoomMessages();
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØºØ±ÙØ©
            addUserToRoom();
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù†Ø¶Ù…Ø§Ù…
            broadcastMessage('userJoined', currentUser);
            
            if (messageInput) messageInput.focus();
            
            console.log('âœ… ØªÙ… Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©:', currentRoom);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØºØ±ÙØ©
        function loadRoomMessages() {
            const roomMessages = JSON.parse(localStorage.getItem(`chat_${currentRoom}`) || '[]');
            messages = roomMessages;
            
            // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">ğŸ‰</div>
                        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h3>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†...</p>
                    </div>
                `;
            } else {
                messages.forEach(message => displayMessage(message));
            }
            
            updateMessageCount();
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØºØ±ÙØ©
        function addUserToRoom() {
            const allRooms = JSON.parse(localStorage.getItem('localChatRooms') || '{}');
            
            if (!allRooms[currentRoom]) {
                allRooms[currentRoom] = {
                    created: Date.now(),
                    users: []
                };
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            const existingUser = allRooms[currentRoom].users.find(u => u.id === currentUser.id);
            if (!existingUser) {
                allRooms[currentRoom].users.push(currentUser);
            }
            
            localStorage.setItem('localChatRooms', JSON.stringify(allRooms));
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            users.clear();
            allRooms[currentRoom].users.forEach(user => {
                users.add(user.username);
            });
            
            updateUserCount();
            updateStats();
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø«
        function broadcastMessage(type, data) {
            if (broadcastChannel) {
                broadcastChannel.postMessage({ type, data });
            }
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
        function displayMessage(message) {
            if (!messagesContainer) return;

            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
            const welcomeMsg = messagesContainer.querySelector('.text-center');
            if (welcomeMsg && messages.length > 0) {
                welcomeMsg.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-animation mb-4';

            if (message.type === 'system') {
                messageDiv.innerHTML = `
                    <div class="flex justify-center">
                        <div class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 
                                    px-4 py-2 rounded-xl text-sm font-medium max-w-md text-center shadow-sm">
                            ${escapeHtml(message.text)}
                        </div>
                    </div>
                `;
            } else {
                const isMyMessage = message.userId === currentUser.id;
                messageDiv.innerHTML = `
                    <div class="flex ${isMyMessage ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-sm lg:max-w-md px-4 py-3 rounded-2xl shadow-sm ${
                            isMyMessage 
                                ? 'bg-blue-500 text-white rounded-br-md' 
                                : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-bl-md border border-gray-200 dark:border-gray-600'
                        }">
                            <div class="text-xs opacity-70 mb-1 font-semibold">
                                ${message.username || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                            </div>
                            <p class="break-words leading-relaxed">${escapeHtml(message.text)}</p>
                            <div class="text-xs opacity-70 mt-2 text-left">
                                ${new Date(message.timestamp).toLocaleTimeString('ar-SA', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                })}
                            </div>
                        </div>
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        function sendMessage() {
            if (!messageInput || !currentRoom) return;
            
            const text = messageInput.value.trim();
            if (!text || text.length > 500) return;

            const message = {
                text: text,
                timestamp: Date.now(),
                type: 'text',
                username: currentUser.username,
                userId: currentUser.id
            };

            // Ø­ÙØ¸ ÙÙŠ localStorage
            messages.push(message);
            localStorage.setItem(`chat_${currentRoom}`, JSON.stringify(messages));

            // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
            displayMessage(message);
            updateMessageCount();

            // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ§Ø¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
            broadcastMessage('newMessage', message);

            messageInput.value = '';
            messageInput.style.height = 'auto';
            updateCharCount();
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø±Ù
        function updateCharCount() {
            if (!messageInput || !charCount) return;
            const count = messageInput.value.length;
            charCount.textContent = `${count}/500`;
            charCount.className = count > 450 ? 'absolute bottom-2 left-2 text-xs text-red-400' : 
                                   count > 400 ? 'absolute bottom-2 left-2 text-xs text-yellow-400' : 
                                   'absolute bottom-2 left-2 text-xs text-gray-400';
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        function updateUserCount() {
            if (userCount) userCount.textContent = `â€¢ ${users.size} Ù…Ø³ØªØ®Ø¯Ù…`;
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function updateMessageCount() {
            if (messageCount) messageCount.textContent = `â€¢ ${messages.length} Ø±Ø³Ø§Ù„Ø©`;
        }

        // Ù…Ø´Ø§Ø±ÙƒØ© ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©
        function shareRoomCode() {
            const code = roomCodeInput.value.trim();
            if (!code) return;

            const shareText = `ğŸ’¬ Ø§Ù†Ø¶Ù… Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ©!\n\nÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©: ${code}\n\nØ§Ù„Ø±Ø§Ø¨Ø·: ${window.location.href}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ©',
                    text: shareText
                });
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showNotification('ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©!', 'success');
                });
            } else {
                showAlert(shareText);
            }
        }

        // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©
        function leaveRoom() {
            if (currentUser) {
                broadcastMessage('userLeft', currentUser);
            }

            if (broadcastChannel) {
                broadcastChannel.close();
            }

            chatScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            messagesContainer.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">ğŸ‰</div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†...</p>
                </div>
            `;

            currentRoom = null;
            currentUser = null;
            messages = [];
            users.clear();
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ¬Ù†Ø¨ XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-40 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white px-6 py-3 rounded-lg shadow-lg`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡
        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6">
                    <div class="text-center">
                        <div class="text-4xl mb-4">ğŸ’¬</div>
                        <p class="text-gray-700 dark:text-gray-300 mb-4 text-sm">${message}</p>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                            Ø­Ø³Ù†Ø§Ù‹
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', () => {
            // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            loginScreen = document.getElementById('loginScreen');
            chatScreen = document.getElementById('chatScreen');
            usernameInput = document.getElementById('usernameInput');
            roomCodeInput = document.getElementById('roomCodeInput');
            enterRoomBtn = document.getElementById('enterRoomBtn');
            enterBtnText = document.getElementById('enterBtnText');
            generateRoomBtn = document.getElementById('generateRoomBtn');
            shareRoomCodeBtn = document.getElementById('shareRoomCodeBtn');
            
            messagesContainer = document.getElementById('messagesContainer');
            messageInput = document.getElementById('messageInput');
            sendMessageBtn = document.getElementById('sendMessageBtn');
            charCount = document.getElementById('charCount');
            roomInfo = document.getElementById('roomInfo');
            userCount = document.getElementById('userCount');
            messageCount = document.getElementById('messageCount');
            activeRooms = document.getElementById('activeRooms');
            totalUsers = document.getElementById('totalUsers');
            shareCurrentRoomBtn = document.getElementById('shareCurrentRoomBtn');
            leaveRoomBtn = document.getElementById('leaveRoomBtn');

            // Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            if (usernameInput) usernameInput.addEventListener('input', updateEnterButton);
            if (roomCodeInput) roomCodeInput.addEventListener('input', updateEnterButton);
            if (enterRoomBtn) enterRoomBtn.addEventListener('click', enterRoom);
            if (generateRoomBtn) generateRoomBtn.addEventListener('click', () => {
                roomCodeInput.value = generateRandomCode();
                updateEnterButton();
            });
            if (shareRoomCodeBtn) shareRoomCodeBtn.addEventListener('click', shareRoomCode);
            if (shareCurrentRoomBtn) shareCurrentRoomBtn.addEventListener('click', () => {
                if (currentRoom) {
                    const shareText = `ğŸ’¬ Ø§Ù†Ø¶Ù… Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ©!\n\nÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©: ${currentRoom}\n\nØ§Ù„Ø±Ø§Ø¨Ø·: ${window.location.href}`;
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(shareText).then(() => {
                            showNotification('ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©!', 'success');
                        });
                    }
                }
            });

            if (messageInput) {
                messageInput.addEventListener('input', () => {
                    updateCharCount();
                    messageInput.style.height = 'auto';
                    messageInput.style.height = messageInput.scrollHeight + 'px';
                });

                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            if (sendMessageBtn) sendMessageBtn.addEventListener('click', sendMessage);
            if (leaveRoomBtn) leaveRoomBtn.addEventListener('click', leaveRoom);

            // Enter Ù„Ù„Ø¯Ø®ÙˆÙ„
            [usernameInput, roomCodeInput].forEach(input => {
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && enterRoomBtn && !enterRoomBtn.disabled) {
                            enterRoom();
                        }
                    });
                }
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±
            updateStats();
            updateEnterButton();
            updateCharCount();

            console.log('âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¬Ø§Ù‡Ø²!');
        });
    </script>
</body>
</html>
