<!-- محادثة تعمل بدون خادم على الإطلاق! -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محادثة محلية - بدون خادم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .dark .gradient-bg { background: linear-gradient(135deg, #2D3748 0%, #1A202C 100%); }
        .message-animation { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .image-hover { transition: all 0.3s ease; }
        .image-hover:hover { transform: scale(1.05); }
        input[type="password"], input[type="text"], textarea { font-size: 16px; }
        .online-indicator { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    
    <!-- شاشة إعداد الغرفة -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full p-8">
            <!-- تنبيه النوع -->
            <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-xl border border-blue-200 dark:border-blue-800">
                <div class="flex items-start space-x-3 space-x-reverse">
                    <div class="text-2xl">💡</div>
                    <div>
                        <h3 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">محادثة محلية</h3>
                        <p class="text-sm text-blue-700 dark:text-blue-300">
                            تعمل بدون خادم! المحادثات محفوظة في المتصفح - تنتهي عند إغلاق الصفحة
                        </p>
                    </div>
                </div>
            </div>

            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 dark:text-white mb-4">💬 المحادثة المحلية</h1>
                <p class="text-gray-600 dark:text-gray-300 text-lg">محادثة فورية بدون خوادم خارجية</p>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- الجانب الأيسر -->
                <div class="space-y-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">👤 معلومات المستخدم</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                    اسم المستخدم:
                                </label>
                                <input type="text" id="usernameInput" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg 
                                              focus:outline-none focus:border-primary dark:bg-gray-600 dark:text-white text-base"
                                       placeholder="أدخل اسمك" required>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                                    كود الغرفة:
                                </label>
                                <input type="text" id="roomCodeInput" 
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg 
                                              focus:outline-none focus:border-primary dark:bg-gray-600 dark:text-white text-base"
                                       placeholder="أدخل كود الغرفة (مثل: test123)" required>
                                <p class="text-xs text-gray-500 mt-1">شارك نفس الكود مع أصدقائك</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- الجانب الأيمن -->
                <div class="space-y-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                        <button id="enterRoomBtn" 
                                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 
                                       text-white font-bold py-4 px-6 rounded-xl text-lg
                                       transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            <span id="enterBtnText">⚠️ يرجى إكمال البيانات</span>
                        </button>
                        
                        <div class="mt-4 space-y-3">
                            <button id="generateRoomBtn" 
                                    class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                🎲 إنشاء كود عشوائي
                            </button>
                            
                            <button id="shareRoomCodeBtn" 
                                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg transition-colors"
                                    disabled>
                                📤 مشاركة الكود
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-xl">
                        <h3 class="font-semibold mb-3 text-gray-800 dark:text-white">📊 إحصائيات</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="text-center p-3 bg-blue-100 dark:bg-blue-900 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="activeRooms">0</div>
                                <div class="text-blue-800 dark:text-blue-300">غرف نشطة</div>
                            </div>
                            <div class="text-center p-3 bg-green-100 dark:bg-green-900 rounded-lg">
                                <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="totalUsers">0</div>
                                <div class="text-green-800 dark:text-green-300">مستخدمين</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- غرفة المحادثة -->
    <div id="chatScreen" class="hidden min-h-screen flex flex-col">
        <!-- شريط علوي -->
        <div class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-6xl mx-auto px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white text-xl font-bold">
                            💬
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                                محادثة محلية
                                <div class="w-2 h-2 bg-green-500 rounded-full mr-2 online-indicator"></div>
                            </h1>
                            <div class="flex items-center space-x-4 space-x-reverse text-sm text-gray-600 dark:text-gray-300">
                                <span id="roomInfo">الغرفة: --</span>
                                <span id="userCount">• 1 مستخدم</span>
                                <span id="messageCount">• 0 رسالة</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <button id="shareCurrentRoomBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            📤 مشاركة
                        </button>
                        <button id="leaveRoomBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                            🚪 مغادرة
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- منطقة المحادثة -->
        <div class="flex-1 flex flex-col max-w-6xl mx-auto w-full">
            <!-- الرسائل -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">🎉</div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">مرحباً بك!</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">ابدأ المحادثة الآن...</p>
                </div>
            </div>

            <!-- منطقة الكتابة -->
            <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
                <div class="flex items-end space-x-4 space-x-reverse">
                    <div class="flex-1 relative">
                        <textarea id="messageInput" 
                                  class="w-full p-4 pr-12 border border-gray-300 dark:border-gray-600 rounded-xl 
                                         resize-none focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20
                                         dark:bg-gray-700 dark:text-white text-base max-h-32"
                                  placeholder="اكتب رسالتك هنا..." 
                                  rows="2"></textarea>
                        <div id="charCount" class="absolute bottom-2 left-2 text-xs text-gray-400">0/500</div>
                    </div>
                    
                    <button id="sendMessageBtn" 
                            class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl transition-colors"
                            title="إرسال رسالة">
                        🚀
                    </button>
                </div>
                
                <div class="mt-3 text-center">
                    <span class="text-xs text-gray-500">المحادثة محفوظة محلياً - تنتهي عند إغلاق المتصفح</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // إعداد الوضع المظلم
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }

        // متغيرات التطبيق
        let currentRoom = null;
        let currentUser = null;
        let messages = [];
        let users = new Set();
        let broadcastChannel = null;

        // عناصر DOM
        let loginScreen, chatScreen, usernameInput, roomCodeInput;
        let enterRoomBtn, enterBtnText, generateRoomBtn, shareRoomCodeBtn;
        let messagesContainer, messageInput, sendMessageBtn, charCount;
        let roomInfo, userCount, messageCount, activeRooms, totalUsers;
        let shareCurrentRoomBtn, leaveRoomBtn;

        // دالة إنشاء كود عشوائي
        function generateRandomCode() {
            const adjectives = ['أحمر', 'أزرق', 'أخضر', 'أصفر', 'بنفسجي', 'وردي', 'برتقالي', 'بني'];
            const nouns = ['قطة', 'كلب', 'أسد', 'نمر', 'فيل', 'زرافة', 'حصان', 'طائر'];
            const numbers = Math.floor(Math.random() * 1000);
            
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            
            return `${adj}_${noun}_${numbers}`;
        }

        // تحديث الإحصائيات
        function updateStats() {
            const allRooms = JSON.parse(localStorage.getItem('localChatRooms') || '{}');
            const roomCount = Object.keys(allRooms).length;
            let userCount = 0;
            
            Object.values(allRooms).forEach(room => {
                userCount += room.users ? room.users.length : 0;
            });
            
            if (activeRooms) activeRooms.textContent = roomCount;
            if (totalUsers) totalUsers.textContent = userCount;
        }

        // تحديث زر الدخول
        function updateEnterButton() {
            const hasUsername = usernameInput && usernameInput.value.trim().length > 0;
            const hasRoomCode = roomCodeInput && roomCodeInput.value.trim().length > 0;
            
            if (enterRoomBtn) {
                enterRoomBtn.disabled = !(hasUsername && hasRoomCode);
                
                if (hasUsername && hasRoomCode) {
                    enterRoomBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    enterBtnText.textContent = '💬 دخول الغرفة';
                } else {
                    enterRoomBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    if (!hasUsername) {
                        enterBtnText.textContent = '👤 أدخل اسم المستخدم';
                    } else if (!hasRoomCode) {
                        enterBtnText.textContent = '🔑 أدخل كود الغرفة';
                    }
                }
            }
            
            // تحديث زر المشاركة
            if (shareRoomCodeBtn) {
                shareRoomCodeBtn.disabled = !hasRoomCode;
                shareRoomCodeBtn.classList.toggle('opacity-50', !hasRoomCode);
            }
        }

        // دخول الغرفة
        function enterRoom() {
            if (!usernameInput.value.trim() || !roomCodeInput.value.trim()) {
                showAlert('يرجى إكمال جميع البيانات');
                return;
            }

            currentRoom = roomCodeInput.value.trim();
            currentUser = {
                id: Date.now().toString(),
                username: usernameInput.value.trim(),
                joinTime: Date.now()
            };

            // إعداد BroadcastChannel للتواصل بين التابات
            if (broadcastChannel) {
                broadcastChannel.close();
            }
            broadcastChannel = new BroadcastChannel(`chat_${currentRoom}`);
            
            broadcastChannel.addEventListener('message', (event) => {
                const { type, data } = event.data;
                
                if (type === 'newMessage') {
                    displayMessage(data);
                    updateMessageCount();
                } else if (type === 'userJoined') {
                    users.add(data.username);
                    updateUserCount();
                    displayMessage({
                        text: `${data.username} انضم للمحادثة 👋`,
                        type: 'system',
                        timestamp: Date.now()
                    });
                } else if (type === 'userLeft') {
                    users.delete(data.username);
                    updateUserCount();
                    displayMessage({
                        text: `${data.username} غادر المحادثة 👋`,
                        type: 'system',
                        timestamp: Date.now()
                    });
                }
            });

            // الانتقال لشاشة المحادثة
            loginScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            
            // تحديث واجهة الغرفة
            if (roomInfo) roomInfo.textContent = `الغرفة: ${currentRoom}`;
            
            // تحميل الرسائل المحفوظة
            loadRoomMessages();
            
            // إضافة المستخدم للغرفة
            addUserToRoom();
            
            // إرسال إشعار انضمام
            broadcastMessage('userJoined', currentUser);
            
            if (messageInput) messageInput.focus();
            
            console.log('✅ تم دخول الغرفة:', currentRoom);
        }

        // تحميل رسائل الغرفة
        function loadRoomMessages() {
            const roomMessages = JSON.parse(localStorage.getItem(`chat_${currentRoom}`) || '[]');
            messages = roomMessages;
            
            // مسح الرسائل القديمة من الواجهة
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">🎉</div>
                        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">مرحباً بك!</h3>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">ابدأ المحادثة الآن...</p>
                    </div>
                `;
            } else {
                messages.forEach(message => displayMessage(message));
            }
            
            updateMessageCount();
        }

        // إضافة المستخدم للغرفة
        function addUserToRoom() {
            const allRooms = JSON.parse(localStorage.getItem('localChatRooms') || '{}');
            
            if (!allRooms[currentRoom]) {
                allRooms[currentRoom] = {
                    created: Date.now(),
                    users: []
                };
            }
            
            // إضافة المستخدم إذا لم يكن موجوداً
            const existingUser = allRooms[currentRoom].users.find(u => u.id === currentUser.id);
            if (!existingUser) {
                allRooms[currentRoom].users.push(currentUser);
            }
            
            localStorage.setItem('localChatRooms', JSON.stringify(allRooms));
            
            // تحديث قائمة المستخدمين المحلية
            users.clear();
            allRooms[currentRoom].users.forEach(user => {
                users.add(user.username);
            });
            
            updateUserCount();
            updateStats();
        }

        // إرسال رسالة عبر البث
        function broadcastMessage(type, data) {
            if (broadcastChannel) {
                broadcastChannel.postMessage({ type, data });
            }
        }

        // عرض رسالة
        function displayMessage(message) {
            if (!messagesContainer) return;

            // إزالة رسالة الترحيب
            const welcomeMsg = messagesContainer.querySelector('.text-center');
            if (welcomeMsg && messages.length > 0) {
                welcomeMsg.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-animation mb-4';

            if (message.type === 'system') {
                messageDiv.innerHTML = `
                    <div class="flex justify-center">
                        <div class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 
                                    px-4 py-2 rounded-xl text-sm font-medium max-w-md text-center shadow-sm">
                            ${escapeHtml(message.text)}
                        </div>
                    </div>
                `;
            } else {
                const isMyMessage = message.userId === currentUser.id;
                messageDiv.innerHTML = `
                    <div class="flex ${isMyMessage ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-sm lg:max-w-md px-4 py-3 rounded-2xl shadow-sm ${
                            isMyMessage 
                                ? 'bg-blue-500 text-white rounded-br-md' 
                                : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-bl-md border border-gray-200 dark:border-gray-600'
                        }">
                            <div class="text-xs opacity-70 mb-1 font-semibold">
                                ${message.username || 'مستخدم غير معروف'}
                            </div>
                            <p class="break-words leading-relaxed">${escapeHtml(message.text)}</p>
                            <div class="text-xs opacity-70 mt-2 text-left">
                                ${new Date(message.timestamp).toLocaleTimeString('ar-SA', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                })}
                            </div>
                        </div>
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // إرسال رسالة
        function sendMessage() {
            if (!messageInput || !currentRoom) return;
            
            const text = messageInput.value.trim();
            if (!text || text.length > 500) return;

            const message = {
                text: text,
                timestamp: Date.now(),
                type: 'text',
                username: currentUser.username,
                userId: currentUser.id
            };

            // حفظ في localStorage
            messages.push(message);
            localStorage.setItem(`chat_${currentRoom}`, JSON.stringify(messages));

            // عرض الرسالة محلياً
            displayMessage(message);
            updateMessageCount();

            // إرسال للتابات الأخرى
            broadcastMessage('newMessage', message);

            messageInput.value = '';
            messageInput.style.height = 'auto';
            updateCharCount();
        }

        // تحديث عداد الأحرف
        function updateCharCount() {
            if (!messageInput || !charCount) return;
            const count = messageInput.value.length;
            charCount.textContent = `${count}/500`;
            charCount.className = count > 450 ? 'absolute bottom-2 left-2 text-xs text-red-400' : 
                                   count > 400 ? 'absolute bottom-2 left-2 text-xs text-yellow-400' : 
                                   'absolute bottom-2 left-2 text-xs text-gray-400';
        }

        // تحديث عداد المستخدمين
        function updateUserCount() {
            if (userCount) userCount.textContent = `• ${users.size} مستخدم`;
        }

        // تحديث عداد الرسائل
        function updateMessageCount() {
            if (messageCount) messageCount.textContent = `• ${messages.length} رسالة`;
        }

        // مشاركة كود الغرفة
        function shareRoomCode() {
            const code = roomCodeInput.value.trim();
            if (!code) return;

            const shareText = `💬 انضم لمحادثة محلية!\n\nكود الغرفة: ${code}\n\nالرابط: ${window.location.href}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'محادثة محلية',
                    text: shareText
                });
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showNotification('تم نسخ كود الغرفة!', 'success');
                });
            } else {
                showAlert(shareText);
            }
        }

        // مغادرة الغرفة
        function leaveRoom() {
            if (currentUser) {
                broadcastMessage('userLeft', currentUser);
            }

            if (broadcastChannel) {
                broadcastChannel.close();
            }

            chatScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            messagesContainer.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">🎉</div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">مرحباً بك!</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mt-2">ابدأ المحادثة الآن...</p>
                </div>
            `;

            currentRoom = null;
            currentUser = null;
            messages = [];
            users.clear();
        }

        // دالة مساعدة لتجنب XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // عرض إشعار
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-40 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white px-6 py-3 rounded-lg shadow-lg`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // عرض تنبيه
        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6">
                    <div class="text-center">
                        <div class="text-4xl mb-4">💬</div>
                        <p class="text-gray-700 dark:text-gray-300 mb-4 text-sm">${message}</p>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                            حسناً
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            // تعريف العناصر
            loginScreen = document.getElementById('loginScreen');
            chatScreen = document.getElementById('chatScreen');
            usernameInput = document.getElementById('usernameInput');
            roomCodeInput = document.getElementById('roomCodeInput');
            enterRoomBtn = document.getElementById('enterRoomBtn');
            enterBtnText = document.getElementById('enterBtnText');
            generateRoomBtn = document.getElementById('generateRoomBtn');
            shareRoomCodeBtn = document.getElementById('shareRoomCodeBtn');
            
            messagesContainer = document.getElementById('messagesContainer');
            messageInput = document.getElementById('messageInput');
            sendMessageBtn = document.getElementById('sendMessageBtn');
            charCount = document.getElementById('charCount');
            roomInfo = document.getElementById('roomInfo');
            userCount = document.getElementById('userCount');
            messageCount = document.getElementById('messageCount');
            activeRooms = document.getElementById('activeRooms');
            totalUsers = document.getElementById('totalUsers');
            shareCurrentRoomBtn = document.getElementById('shareCurrentRoomBtn');
            leaveRoomBtn = document.getElementById('leaveRoomBtn');

            // مستمعي الأحداث
            if (usernameInput) usernameInput.addEventListener('input', updateEnterButton);
            if (roomCodeInput) roomCodeInput.addEventListener('input', updateEnterButton);
            if (enterRoomBtn) enterRoomBtn.addEventListener('click', enterRoom);
            if (generateRoomBtn) generateRoomBtn.addEventListener('click', () => {
                roomCodeInput.value = generateRandomCode();
                updateEnterButton();
            });
            if (shareRoomCodeBtn) shareRoomCodeBtn.addEventListener('click', shareRoomCode);
            if (shareCurrentRoomBtn) shareCurrentRoomBtn.addEventListener('click', () => {
                if (currentRoom) {
                    const shareText = `💬 انضم لمحادثة محلية!\n\nكود الغرفة: ${currentRoom}\n\nالرابط: ${window.location.href}`;
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(shareText).then(() => {
                            showNotification('تم نسخ معلومات الغرفة!', 'success');
                        });
                    }
                }
            });

            if (messageInput) {
                messageInput.addEventListener('input', () => {
                    updateCharCount();
                    messageInput.style.height = 'auto';
                    messageInput.style.height = messageInput.scrollHeight + 'px';
                });

                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            if (sendMessageBtn) sendMessageBtn.addEventListener('click', sendMessage);
            if (leaveRoomBtn) leaveRoomBtn.addEventListener('click', leaveRoom);

            // Enter للدخول
            [usernameInput, roomCodeInput].forEach(input => {
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && enterRoomBtn && !enterRoomBtn.disabled) {
                            enterRoom();
                        }
                    });
                }
            });

            // تحديث الإحصائيات والأزرار
            updateStats();
            updateEnterButton();
            updateCharCount();

            console.log('✅ تطبيق المحادثة المحلية جاهز!');
        });
    </script>
</body>
</html>
